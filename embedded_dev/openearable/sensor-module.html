<!DOCTYPE html>

<html lang="zh-CN"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/search/style.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/custom.css" type="text/css"/>
        
    
    
    <title>传感器管理模块详细分析 - 7h4Worker</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": null, "update": [], "ts": 0, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/lhfdoc.github.io/">
                
                
                    <h2>嵌入式开发</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
</ul>

            </div>
            <div>
                <ul id="nav_right">
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/index.html"><span class="label">嵌入式开发</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">🎧 OpenEarable 2.0</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/index.html"><span class="label">项目入门</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/project-overview.html"><span class="label">📋 项目概述</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/architecture.html"><span class="label">🏗️ 系统架构</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/deployment.html"><span class="label">🚀 部署指南</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/teedoc-guide.html"><span class="label">📖 teedoc使用指南</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">核心功能模块</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/battery-module.html"><span class="label">🔋 电源管理模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/audio-module.html"><span class="label">🎵 音频处理模块</span><span class=""></span></a></li>
<li class="active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/sensor-module.html"><span class="label">📡 传感器管理模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/bluetooth-module.html"><span class="label">📶 蓝牙通信模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/storage-module.html"><span class="label">💾 数据存储模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/drivers-module.html"><span class="label">🔧 硬件驱动模块</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">辅助功能模块</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/buttons-module.html"><span class="label">🎮 按键处理模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/parseinfo-module.html"><span class="label">📊 数据解析模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/wire-module.html"><span class="label">🔌 I2C通信模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/utils-module.html"><span class="label">🛠️ 系统工具模块</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">💻 硬件平台</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/nordic.html&from=/embedded_dev/hardware_platforms/nordic.html"><span class="label">Nordic nRF系列</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/esp32.html&from=/embedded_dev/hardware_platforms/esp32.html"><span class="label">ESP32系列</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/stm32.html&from=/embedded_dev/hardware_platforms/stm32.html"><span class="label">STM32系列</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">⚙️ 实时操作系统</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/zephyr.html&from=/embedded_dev/rtos/zephyr.html"><span class="label">Zephyr RTOS</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/freertos.html&from=/embedded_dev/rtos/freertos.html"><span class="label">FreeRTOS</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/rtthread.html&from=/embedded_dev/rtos/rtthread.html"><span class="label">RT-Thread</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">🔗 通信协议</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/bluetooth.html&from=/embedded_dev/protocols/bluetooth.html"><span class="label">蓝牙协议</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/wifi.html&from=/embedded_dev/protocols/wifi.html"><span class="label">WiFi协议</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/lora.html&from=/embedded_dev/protocols/lora.html"><span class="label">LoRa/LoRaWAN</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">🛠️ 开发工具</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/ide.html&from=/embedded_dev/tools/ide.html"><span class="label">IDE环境</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/debug.html&from=/embedded_dev/tools/debug.html"><span class="label">调试工具</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/simulation.html&from=/embedded_dev/tools/simulation.html"><span class="label">仿真平台</span><span class=""></span></a></li>
</ul>
</li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>传感器管理模块详细分析</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="最后修改日期： 2025-07-07">
                                    2025-07-07
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <h2 id="%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0">模块概述</h2>
<p>传感器管理模块是OpenEarable 2.0的核心创新组件，负责管理集成的多种高精度传感器，包括IMU、PPG、温度、气压、麦克风等传感器。该模块提供统一的传感器接口、数据采集、处理和传输功能，是OpenEarable区别于普通音频设备的关键特性。</p>
<h2 id="%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84">文件结构</h2>

<pre class="language-none"><code class="language-none">src/SensorManager/
├── SensorManager.h/.cpp      # 传感器管理器核心
├── EdgeMLSensor.h/.cpp       # 传感器基类定义
├── IMU.h/.cpp               # 惯性测量单元传感器
├── PPG.h/.cpp               # 光电容积脉搏波传感器
├── Baro.h/.cpp              # 气压传感器
├── Temp.h/.cpp              # 温度传感器
├── BoneConduction.h/.cpp    # 骨传导传感器
├── Microphone.h/.cpp        # 麦克风传感器
├── BMX160/                  # BMX160 IMU驱动
├── MAXM86161/              # MAXM86161 PPG驱动
├── BMP388/                 # BMP388 气压计驱动
├── MLX90632/               # MLX90632 红外温度计驱动
├── BMA580/                 # BMA580 加速度计驱动
├── CMakeLists.txt          # 构建配置
└── Kconfig                 # 配置选项
</code></pre>
<h2 id="%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84">核心架构</h2>
<h3 id="1.-SensorManager---%E4%BC%A0%E6%84%9F%E5%99%A8%E7%AE%A1%E7%90%86%E5%99%A8">1. SensorManager - 传感器管理器</h3>
<p>SensorManager是整个传感器系统的核心控制组件，负责传感器的生命周期管理、数据流控制和系统协调。</p>
<h4 id="%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">主要功能</h4>
<ul>
<li><strong>传感器生命周期管理</strong>: 初始化、启动、停止传感器</li>
<li><strong>数据流管理</strong>: 传感器数据的采集、缓冲和分发</li>
<li><strong>配置管理</strong>: 动态配置传感器参数</li>
<li><strong>消息总线集成</strong>: 通过ZBus与其他模块通信</li>
<li><strong>存储管理</strong>: 控制数据的本地存储和蓝牙传输</li>
</ul>
<h4 id="%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3">核心接口</h4>

<pre class="language-cpp"><code class="language-cpp">// 传感器管理器状态
enum sensor_manager_state {
    INIT,           // 初始化状态
    RUNNING,        // 运行状态
    SUSPENDED,      // 挂起状态
};

// 主要控制接口
void init_sensor_manager();                        // 初始化传感器管理器
void start_sensor_manager();                       // 启动传感器管理器
void stop_sensor_manager();                        // 停止传感器管理器
void config_sensor(struct sensor_config *config);  // 配置传感器
enum sensor_manager_state get_state();             // 获取管理器状态
</code></pre>
<h4 id="%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%9E%B6%E6%9E%84">工作队列架构</h4>

<pre class="language-cpp"><code class="language-cpp">// 传感器专用工作队列
extern struct k_work_q sensor_work_q;

// 消息队列定义
K_MSGQ_DEFINE(sensor_queue, sizeof(struct sensor_msg), 256, 4);
K_MSGQ_DEFINE(config_queue, sizeof(struct sensor_config), 16, 4);

// ZBus通道定义
ZBUS_CHAN_DEFINE(sensor_chan, struct sensor_msg, NULL, NULL, 
                 ZBUS_OBSERVERS_EMPTY, ZBUS_MSG_INIT(0));
</code></pre>
<h3 id="2.-EdgeMLSensor---%E4%BC%A0%E6%84%9F%E5%99%A8%E5%9F%BA%E7%B1%BB">2. EdgeMLSensor - 传感器基类</h3>
<p>EdgeMLSensor是所有传感器类的抽象基类，定义了统一的传感器接口和行为模式。</p>
<h4 id="%E8%AE%BE%E8%AE%A1%E7%89%B9%E7%82%B9">设计特点</h4>
<ul>
<li><strong>纯虚函数接口</strong>: 强制子类实现核心功能</li>
<li><strong>统一的生命周期</strong>: 标准化的初始化、启动、停止流程</li>
<li><strong>配置化采样率</strong>: 支持多档位采样率配置</li>
<li><strong>双重数据流</strong>: 支持SD卡存储和蓝牙传输</li>
</ul>
<h4 id="%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3">核心接口</h4>

<pre class="language-cpp"><code class="language-cpp">template &lt;size_t N&gt;
struct SampleRateSetting {
    uint8_t reg_vals[N];        // 寄存器配置值
    float sample_rates[N];      // 标称采样率
    float true_sample_rates[N]; // 实际采样率
};

class EdgeMlSensor {
public:
    // 纯虚函数接口
    virtual bool init(struct k_msgq *queue) = 0;   // 初始化传感器
    virtual void start(int sample_rate_idx) = 0;   // 启动传感器
    virtual void stop() = 0;                       // 停止传感器

    // 状态查询和控制
    bool is_running();                             // 检查运行状态
    void sd_logging(bool enable);                  // 控制SD卡记录
    void ble_stream(bool enable);                  // 控制蓝牙流传输

protected:
    k_work sensor_work;         // 传感器工作项
    k_timer sensor_timer;       // 传感器定时器
    static k_msgq *sensor_queue; // 传感器消息队列

    bool _sd_logging = false;   // SD卡记录标志
    bool _ble_stream = true;    // 蓝牙传输标志
    bool _running = false;      // 运行状态标志
};
</code></pre>
<h2 id="%E4%BC%A0%E6%84%9F%E5%99%A8%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3">传感器实现详解</h2>
<h3 id="1.-IMU-%E4%BC%A0%E6%84%9F%E5%99%A8-%28BMX160%29">1. IMU 传感器 (BMX160)</h3>
<p>IMU传感器基于Bosch BMX160九轴传感器，提供加速度计、陀螺仪和磁力计数据。</p>
<h4 id="%E6%8A%80%E6%9C%AF%E8%A7%84%E6%A0%BC">技术规格</h4>
<ul>
<li><strong>加速度计</strong>: ±2g/±4g/±8g/±16g量程，14位分辨率</li>
<li><strong>陀螺仪</strong>: ±125°/s到±2000°/s量程，16位分辨率</li>
<li><strong>磁力计</strong>: ±1300μT量程，高精度磁场测量</li>
</ul>
<h4 id="%E9%87%87%E6%A0%B7%E7%8E%87%E9%85%8D%E7%BD%AE">采样率配置</h4>

<pre class="language-cpp"><code class="language-cpp">class IMU : public EdgeMlSensor {
public:
    const static SampleRateSetting&lt;6&gt; sample_rates;

private:
    static DFRobot_BMX160 imu;  // BMX160驱动实例
};

// 支持的采样率设置
const SampleRateSetting&lt;6&gt; IMU::sample_rates = {
    .reg_vals = {0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C},
    .sample_rates = {25.0, 50.0, 100.0, 200.0, 400.0, 800.0},
    .true_sample_rates = {25.32, 50.64, 101.28, 202.56, 405.12, 810.24}
};
</code></pre>
<h4 id="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</h4>

<pre class="language-cpp"><code class="language-cpp">struct imu_data {
    float accel_x, accel_y, accel_z;    // 加速度 (m/s²)
    float gyro_x, gyro_y, gyro_z;       // 角速度 (rad/s)
    float mag_x, mag_y, mag_z;          // 磁场强度 (μT)
    uint64_t timestamp;                 // 时间戳 (μs)
} __attribute__((packed));
</code></pre>
<h3 id="2.-PPG-%E4%BC%A0%E6%84%9F%E5%99%A8-%28MAXM86161%29">2. PPG 传感器 (MAXM86161)</h3>
<p>PPG传感器基于Maxim MAXM86161光学传感器，用于心率监测、血氧测量和生理信号分析。</p>
<h4 id="%E6%8A%80%E6%9C%AF%E8%A7%84%E6%A0%BC">技术规格</h4>
<ul>
<li><strong>光源</strong>: 红光、红外光、绿光LED</li>
<li><strong>光电二极管</strong>: 高灵敏度光电检测器</li>
<li><strong>采样率</strong>: 最高3200Hz</li>
<li><strong>分辨率</strong>: 19位ADC</li>
</ul>
<h4 id="LED%E9%85%8D%E7%BD%AE">LED配置</h4>

<pre class="language-cpp"><code class="language-cpp">enum led_order {
    red,        // 红光LED (660nm)
    green,      // 绿光LED (537nm) 
    ir,         // 红外LED (880nm)
    ambient     // 环境光检测
};

class PPG : public EdgeMlSensor {
public:
    const static SampleRateSetting&lt;16&gt; sample_rates;

private:
    static MAXM86161 ppg;           // MAXM86161驱动实例
    ppg_sample data_buffer[64];     // 数据缓冲区
};
</code></pre>
<h4 id="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</h4>

<pre class="language-cpp"><code class="language-cpp">struct ppg_sample {
    uint32_t red;           // 红光通道数据
    uint32_t ir;            // 红外通道数据
    uint32_t green;         // 绿光通道数据
    uint32_t ambient;       // 环境光数据
    uint64_t timestamp;     // 时间戳
} __attribute__((packed));
</code></pre>
<h3 id="3.-%E6%B8%A9%E5%BA%A6%E4%BC%A0%E6%84%9F%E5%99%A8-%28MLX90632%29">3. 温度传感器 (MLX90632)</h3>
<p>温度传感器基于Melexis MLX90632非接触式红外温度计，可测量物体温度和环境温度。</p>
<h4 id="%E6%8A%80%E6%9C%AF%E8%A7%84%E6%A0%BC">技术规格</h4>
<ul>
<li><strong>测量范围</strong>: -20°C到85°C (环境), -20°C到200°C (物体)</li>
<li><strong>精度</strong>: ±0.2°C (典型值)</li>
<li><strong>响应时间</strong>: &lt;1秒</li>
<li><strong>接口</strong>: I2C</li>
</ul>
<h4 id="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</h4>

<pre class="language-cpp"><code class="language-cpp">struct temp_data {
    float ambient_temp;     // 环境温度 (°C)
    float object_temp;      // 物体温度 (°C)
    uint64_t timestamp;     // 时间戳
} __attribute__((packed));
</code></pre>
<h3 id="4.-%E6%B0%94%E5%8E%8B%E4%BC%A0%E6%84%9F%E5%99%A8-%28BMP388%29">4. 气压传感器 (BMP388)</h3>
<p>气压传感器基于Bosch BMP388高精度气压计，用于高度测量和环境监测。</p>
<h4 id="%E6%8A%80%E6%9C%AF%E8%A7%84%E6%A0%BC">技术规格</h4>
<ul>
<li><strong>压力范围</strong>: 300-1250 hPa</li>
<li><strong>精度</strong>: ±0.08 hPa (典型值)</li>
<li><strong>高度分辨率</strong>: ±8 cm</li>
<li><strong>温度补偿</strong>: 集成温度传感器</li>
</ul>
<h4 id="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</h4>

<pre class="language-cpp"><code class="language-cpp">struct baro_data {
    float pressure;         // 大气压力 (hPa)
    float temperature;      // 温度 (°C)
    float altitude;         // 海拔高度 (m)
    uint64_t timestamp;     // 时间戳
} __attribute__((packed));
</code></pre>
<h3 id="5.-%E9%AA%A8%E4%BC%A0%E5%AF%BC%E4%BC%A0%E6%84%9F%E5%99%A8">5. 骨传导传感器</h3>
<p>骨传导传感器通过检测颅骨振动来感知语音和咀嚼等生理活动。</p>
<h4 id="%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">实现原理</h4>
<ul>
<li><strong>振动检测</strong>: 高灵敏度加速度计检测骨传导振动</li>
<li><strong>信号处理</strong>: 数字滤波和特征提取</li>
<li><strong>模式识别</strong>: 语音活动检测(VAD)</li>
</ul>
<h4 id="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据结构</h4>

<pre class="language-cpp"><code class="language-cpp">struct bone_conduction_data {
    float vibration_x, vibration_y, vibration_z;   // 三轴振动数据
    float rms_amplitude;                           // RMS振幅
    bool voice_activity;                           // 语音活动标志
    uint64_t timestamp;                            // 时间戳
} __attribute__((packed));
</code></pre>
<h2 id="%E6%95%B0%E6%8D%AE%E6%B5%81%E6%9E%B6%E6%9E%84">数据流架构</h2>
<h3 id="%E4%BC%A0%E6%84%9F%E5%99%A8%E6%95%B0%E6%8D%AE%E6%B5%81">传感器数据流</h3>

<pre class="language-none"><code class="language-none">[传感器硬件] → [驱动层] → [EdgeMLSensor] → [SensorManager] → [数据分发]
                                                                    ↓
                                                              [SD卡存储]
                                                                    ↓
                                                              [蓝牙传输]
</code></pre>
<h3 id="%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%B3%BB%E7%BB%9F">消息队列系统</h3>

<pre class="language-cpp"><code class="language-cpp">// 传感器消息结构
struct sensor_msg {
    bool sd;                    // SD卡存储标志
    bool stream;                // 蓝牙传输标志
    struct sensor_data data;    // 传感器数据
};

// 传感器数据结构
struct sensor_data {
    uint8_t id;                 // 传感器ID
    uint8_t size;               // 数据大小
    uint64_t time;              // 时间戳
    uint8_t data[36];           // 数据载荷
} __attribute__((packed));
</code></pre>
<h3 id="%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F">配置系统</h3>

<pre class="language-cpp"><code class="language-cpp">// 传感器配置结构
struct sensor_config {
    uint8_t sensorId;           // 传感器ID
    uint8_t sampleRateIndex;    // 采样率索引
    uint8_t storageOptions;     // 存储选项
} __attribute__((packed));

// 传感器ID枚举
enum sensor_id {
    ID_IMU = 0,                 // 惯性测量单元
    ID_TEMP_BARO = 1,           // 温度气压传感器
    ID_MICRO = 2,               // 麦克风
    ID_PPG = 4,                 // 光电容积脉搏波
    ID_PULSOX = 5,              // 脉搏血氧
    ID_OPTTEMP = 6,             // 光学温度计
    ID_BONE_CONDUCTION = 7,     // 骨传导传感器
};
</code></pre>
<h2 id="%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E4%B8%AD%E6%96%AD%E7%B3%BB%E7%BB%9F">定时器和中断系统</h2>
<h3 id="%E5%AE%9A%E6%97%B6%E5%99%A8%E9%A9%B1%E5%8A%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86">定时器驱动的数据采集</h3>

<pre class="language-cpp"><code class="language-cpp">class IMU : public EdgeMlSensor {
private:
    // 定时器中断处理函数
    static void sensor_timer_handler(struct k_timer *dummy) {
        k_work_submit_to_queue(&amp;sensor_work_q, &amp;sensor.sensor_work);
    }

    // 传感器数据更新工作项
    static void update_sensor(struct k_work *work) {
        // 1. 读取传感器数据
        bmx160_data_t raw_data;
        imu.read_sensor_data(&amp;raw_data);

        // 2. 数据格式转换
        struct sensor_data sensor_data;
        format_imu_data(&amp;raw_data, &amp;sensor_data);

        // 3. 发送到消息队列
        struct sensor_msg msg = {
            .sd = sensor._sd_logging,
            .stream = sensor._ble_stream,
            .data = sensor_data
        };
        k_msgq_put(&amp;sensor_queue, &amp;msg, K_NO_WAIT);
    }
};
</code></pre>
<h3 id="%E4%B8%AD%E6%96%AD%E9%A9%B1%E5%8A%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E6%A3%80%E6%B5%8B">中断驱动的事件检测</h3>

<pre class="language-cpp"><code class="language-cpp">// PPG传感器的FIFO中断处理
void ppg_fifo_interrupt_handler() {
    // 1. 读取FIFO数据
    uint8_t fifo_samples = ppg.get_fifo_samples();

    for (int i = 0; i &lt; fifo_samples; i++) {
        // 2. 处理每个样本
        ppg_sample sample;
        ppg.read_fifo_sample(&amp;sample);

        // 3. 质量检查和处理
        if (is_valid_ppg_sample(&amp;sample)) {
            process_ppg_data(&amp;sample);
        }
    }
}
</code></pre>
<h2 id="%E5%8A%9F%E8%80%97%E7%AE%A1%E7%90%86">功耗管理</h2>
<h3 id="%E5%8A%A8%E6%80%81%E5%8A%9F%E8%80%97%E6%8E%A7%E5%88%B6">动态功耗控制</h3>

<pre class="language-cpp"><code class="language-cpp">void sensor_power_management() {
    // 根据活跃传感器数量调整功耗
    if (active_sensors == 0) {
        // 无活跃传感器，进入低功耗模式
        set_sensor_power_mode(POWER_MODE_SLEEP);
    } else if (active_sensors &lt;= 2) {
        // 少量传感器，中等功耗模式
        set_sensor_power_mode(POWER_MODE_NORMAL);
    } else {
        // 多传感器，高性能模式
        set_sensor_power_mode(POWER_MODE_HIGH_PERFORMANCE);
    }
}
</code></pre>
<h3 id="%E9%87%87%E6%A0%B7%E7%8E%87%E8%87%AA%E9%80%82%E5%BA%94">采样率自适应</h3>

<pre class="language-cpp"><code class="language-cpp">void adaptive_sampling_rate() {
    // 根据电池电量和数据需求调整采样率
    uint8_t battery_level = get_battery_level();

    if (battery_level &lt; 20) {
        // 低电量时降低采样率
        reduce_sensor_sampling_rates();
    } else if (battery_level &gt; 80) {
        // 电量充足时恢复正常采样率
        restore_sensor_sampling_rates();
    }
}
</code></pre>
<h2 id="%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%92%8C%E5%88%86%E6%9E%90">数据处理和分析</h2>
<h3 id="%E5%AE%9E%E6%97%B6%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86">实时信号处理</h3>

<pre class="language-cpp"><code class="language-cpp">// IMU数据的运动检测
bool detect_motion(imu_data *data) {
    // 计算加速度向量的幅值
    float accel_magnitude = sqrt(data-&gt;accel_x * data-&gt;accel_x +
                                data-&gt;accel_y * data-&gt;accel_y +
                                data-&gt;accel_z * data-&gt;accel_z);

    // 判断是否有显著运动
    return (accel_magnitude &gt; MOTION_THRESHOLD);
}

// PPG数据的心率检测
float calculate_heart_rate(ppg_sample *samples, int count) {
    // 1. 信号预处理
    filter_ppg_signal(samples, count);

    // 2. 峰值检测
    int peak_count = detect_peaks(samples, count);

    // 3. 心率计算
    float sampling_period = 1.0f / PPG_SAMPLE_RATE;
    float heart_rate = (peak_count * 60.0f) / (count * sampling_period);

    return heart_rate;
}
</code></pre>
<h3 id="%E4%BC%A0%E6%84%9F%E5%99%A8%E8%9E%8D%E5%90%88">传感器融合</h3>

<pre class="language-cpp"><code class="language-cpp">// 多传感器融合的姿态估计
void sensor_fusion_update(imu_data *imu, mag_data *mag) {
    // 1. 加速度计姿态估计
    float accel_roll = atan2(imu-&gt;accel_y, imu-&gt;accel_z);
    float accel_pitch = atan2(-imu-&gt;accel_x, 
                             sqrt(imu-&gt;accel_y * imu-&gt;accel_y + 
                                  imu-&gt;accel_z * imu-&gt;accel_z));

    // 2. 陀螺仪姿态积分
    integrate_gyroscope_data(imu);

    // 3. 磁力计偏航角计算
    float mag_yaw = atan2(mag-&gt;mag_y, mag-&gt;mag_x);

    // 4. 互补滤波器融合
    complementary_filter_update(accel_roll, accel_pitch, mag_yaw);
}
</code></pre>
<h2 id="%E6%A0%A1%E5%87%86%E5%92%8C%E8%A1%A5%E5%81%BF">校准和补偿</h2>
<h3 id="%E4%BC%A0%E6%84%9F%E5%99%A8%E6%A0%A1%E5%87%86">传感器校准</h3>

<pre class="language-cpp"><code class="language-cpp">// IMU零偏校准
void calibrate_imu_bias() {
    const int calibration_samples = 1000;
    float accel_bias[3] = {0, 0, 0};
    float gyro_bias[3] = {0, 0, 0};

    // 收集校准数据
    for (int i = 0; i &lt; calibration_samples; i++) {
        imu_data data;
        read_imu_data(&amp;data);

        accel_bias[0] += data.accel_x;
        accel_bias[1] += data.accel_y;
        accel_bias[2] += data.accel_z - 9.81f; // 重力补偿

        gyro_bias[0] += data.gyro_x;
        gyro_bias[1] += data.gyro_y;
        gyro_bias[2] += data.gyro_z;

        k_sleep(K_MSEC(1));
    }

    // 计算平均偏差
    for (int i = 0; i &lt; 3; i++) {
        accel_bias[i] /= calibration_samples;
        gyro_bias[i] /= calibration_samples;
    }

    // 存储校准参数
    store_calibration_data(accel_bias, gyro_bias);
}
</code></pre>
<h3 id="%E6%B8%A9%E5%BA%A6%E8%A1%A5%E5%81%BF">温度补偿</h3>

<pre class="language-cpp"><code class="language-cpp">// PPG温度补偿
void temperature_compensation_ppg(ppg_sample *sample, float temperature) {
    // 基于温度的增益补偿
    float temp_coeff = 1.0f + (temperature - 25.0f) * 0.001f;

    sample-&gt;red = (uint32_t)(sample-&gt;red * temp_coeff);
    sample-&gt;ir = (uint32_t)(sample-&gt;ir * temp_coeff);
    sample-&gt;green = (uint32_t)(sample-&gt;green * temp_coeff);
}
</code></pre>
<h2 id="%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9">配置选项</h2>
<h3 id="Kconfig%E9%85%8D%E7%BD%AE">Kconfig配置</h3>

<pre class="language-kconfig"><code class="language-kconfig"># 传感器管理器配置
CONFIG_SENSOR_WORK_QUEUE_STACK_SIZE=2048
CONFIG_SENSOR_WORK_QUEUE_PRIO=5
CONFIG_SENSOR_PUB_STACK_SIZE=1024
CONFIG_SENSOR_PUB_THREAD_PRIO=6

# 传感器使能
CONFIG_SENSOR_IMU=y
CONFIG_SENSOR_PPG=y
CONFIG_SENSOR_TEMPERATURE=y
CONFIG_SENSOR_BAROMETER=y
CONFIG_SENSOR_BONE_CONDUCTION=y

# 采样率配置
CONFIG_IMU_DEFAULT_SAMPLE_RATE=100
CONFIG_PPG_DEFAULT_SAMPLE_RATE=400
CONFIG_TEMP_DEFAULT_SAMPLE_RATE=10

# 数据缓冲配置
CONFIG_SENSOR_QUEUE_SIZE=256
CONFIG_SENSOR_BUFFER_SIZE=64
</code></pre>
<h2 id="%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%92%8C%E8%AF%8A%E6%96%AD">错误处理和诊断</h2>
<h3 id="%E4%BC%A0%E6%84%9F%E5%99%A8%E5%81%A5%E5%BA%B7%E7%9B%91%E6%8E%A7">传感器健康监控</h3>

<pre class="language-cpp"><code class="language-cpp">void sensor_health_check() {
    // 检查各传感器状态
    for (int id = 0; id &lt; NUM_SENSORS; id++) {
        EdgeMlSensor *sensor = get_sensor((sensor_id)id);

        if (sensor &amp;&amp; sensor-&gt;is_running()) {
            // 检查数据更新频率
            if (sensor_data_rate[id] &lt; expected_rate[id] * 0.8f) {
                LOG_WRN(&quot;Sensor %d data rate low: %.1f Hz&quot;, 
                       id, sensor_data_rate[id]);

                // 尝试重启传感器
                sensor-&gt;stop();
                k_sleep(K_MSEC(100));
                sensor-&gt;start(sensor_config[id].sample_rate_idx);
            }
        }
    }
}
</code></pre>
<h3 id="%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F%E6%A3%80%E6%9F%A5">数据质量检查</h3>

<pre class="language-cpp"><code class="language-cpp">bool validate_sensor_data(struct sensor_data *data) {
    switch (data-&gt;id) {
        case ID_IMU:
            return validate_imu_data((imu_data*)data-&gt;data);
        case ID_PPG:
            return validate_ppg_data((ppg_sample*)data-&gt;data);
        case ID_TEMP_BARO:
            return validate_temp_baro_data((temp_baro_data*)data-&gt;data);
        default:
            return true;
    }
}
</code></pre>
<h2 id="%E6%80%BB%E7%BB%93">总结</h2>
<p>传感器管理模块是OpenEarable 2.0的核心创新特性，具有以下关键优势：</p>
<ol>
<li><strong>多传感器集成</strong>: 支持IMU、PPG、温度、气压等多种传感器</li>
<li><strong>统一管理接口</strong>: 通过EdgeMLSensor基类提供统一的传感器接口</li>
<li><strong>高效数据流</strong>: 基于消息队列和ZBus的高效数据传输</li>
<li><strong>灵活配置</strong>: 支持动态配置采样率和存储选项</li>
<li><strong>实时处理</strong>: 低延迟的数据采集和处理能力</li>
<li><strong>功耗优化</strong>: 智能的功耗管理和自适应采样</li>
<li><strong>数据质量</strong>: 完善的校准、补偿和质量检查机制</li>
<li><strong>模块化设计</strong>: 易于扩展新的传感器类型</li>
</ol>
<p>该模块为OpenEarable 2.0提供了强大的传感器数据采集和处理能力，支持各种生理监测、运动追踪和环境感知应用，是实现智能耳戴式设备功能的核心基础。</p>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/lhfdoc.github.io/embedded_dev/openearable/audio-module.html">
                            <span class="icon"></span>
                            <span class="label">🎵 音频处理模块</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/lhfdoc.github.io/embedded_dev/openearable/bluetooth-module.html">
                            <span class="label">📶 蓝牙通信模块</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>相关资源</a><ul><li><a target="_blank" href="https://www.nordicsemi.com/">Nordic官网</a></li>
<li><a target="_blank" href="https://zephyrproject.org/">Zephyr项目</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/lhfdoc.github.io/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/main.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/css/theme_default/prism.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/search/search_main.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/custom.js"></script>
    
</body>

</html>