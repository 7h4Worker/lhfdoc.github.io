<!DOCTYPE html>

<html lang="zh-CN"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/search/style.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/custom.css" type="text/css"/>
        
    
    
    <title>ç”µæºç®¡ç†æ¨¡å—è¯¦ç»†åˆ†æ - 7h4Worker</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": null, "update": [], "ts": 0, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/lhfdoc.github.io/">
                
                
                    <h2>åµŒå…¥å¼å¼€å‘</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
</ul>

            </div>
            <div>
                <ul id="nav_right">
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">æœç´¢</span>
                            <div id="search_hints">
                                <span id="search_input_hint">è¾“å…¥å…³é”®è¯ï¼Œå¤šå…³é”®è¯ç©ºæ ¼éš”å¼€</span>
                                <span id="search_loading_hint">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™ã€‚ã€‚ã€‚</span>
                                <span id="search_download_err_hint">ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œ</span>
                                <span id="search_other_docs_result_hint">æ¥è‡ªå…¶å®ƒæ–‡æ¡£çš„ç»“æœ</span>
                                <span id="search_curr_doc_result_hint">å½“å‰æ–‡æ¡£æœç´¢ç»“æœ</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/index.html"><span class="label">åµŒå…¥å¼å¼€å‘</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">ğŸ§ OpenEarable 2.0</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/index.html"><span class="label">é¡¹ç›®å…¥é—¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/project-overview.html"><span class="label">ğŸ“‹ é¡¹ç›®æ¦‚è¿°</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/architecture.html"><span class="label">ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/deployment.html"><span class="label">ğŸš€ éƒ¨ç½²æŒ‡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/teedoc-guide.html"><span class="label">ğŸ“– teedocä½¿ç”¨æŒ‡å—</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">æ ¸å¿ƒåŠŸèƒ½æ¨¡å—</span><span class="sub_indicator"></span></a><ul class="show">
<li class="active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/battery-module.html"><span class="label">ğŸ”‹ ç”µæºç®¡ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/audio-module.html"><span class="label">ğŸµ éŸ³é¢‘å¤„ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/sensor-module.html"><span class="label">ğŸ“¡ ä¼ æ„Ÿå™¨ç®¡ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/bluetooth-module.html"><span class="label">ğŸ“¶ è“ç‰™é€šä¿¡æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/storage-module.html"><span class="label">ğŸ’¾ æ•°æ®å­˜å‚¨æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/drivers-module.html"><span class="label">ğŸ”§ ç¡¬ä»¶é©±åŠ¨æ¨¡å—</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">è¾…åŠ©åŠŸèƒ½æ¨¡å—</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/buttons-module.html"><span class="label">ğŸ® æŒ‰é”®å¤„ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/parseinfo-module.html"><span class="label">ğŸ“Š æ•°æ®è§£ææ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/wire-module.html"><span class="label">ğŸ”Œ I2Cé€šä¿¡æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/utils-module.html"><span class="label">ğŸ› ï¸ ç³»ç»Ÿå·¥å…·æ¨¡å—</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ğŸ’» ç¡¬ä»¶å¹³å°</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/nordic.html&from=/embedded_dev/hardware_platforms/nordic.html"><span class="label">Nordic nRFç³»åˆ—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/esp32.html&from=/embedded_dev/hardware_platforms/esp32.html"><span class="label">ESP32ç³»åˆ—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/stm32.html&from=/embedded_dev/hardware_platforms/stm32.html"><span class="label">STM32ç³»åˆ—</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">âš™ï¸ å®æ—¶æ“ä½œç³»ç»Ÿ</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/zephyr.html&from=/embedded_dev/rtos/zephyr.html"><span class="label">Zephyr RTOS</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/freertos.html&from=/embedded_dev/rtos/freertos.html"><span class="label">FreeRTOS</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/rtthread.html&from=/embedded_dev/rtos/rtthread.html"><span class="label">RT-Thread</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ğŸ”— é€šä¿¡åè®®</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/bluetooth.html&from=/embedded_dev/protocols/bluetooth.html"><span class="label">è“ç‰™åè®®</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/wifi.html&from=/embedded_dev/protocols/wifi.html"><span class="label">WiFiåè®®</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/lora.html&from=/embedded_dev/protocols/lora.html"><span class="label">LoRa/LoRaWAN</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ğŸ› ï¸ å¼€å‘å·¥å…·</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/ide.html&from=/embedded_dev/tools/ide.html"><span class="label">IDEç¯å¢ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/debug.html&from=/embedded_dev/tools/debug.html"><span class="label">è°ƒè¯•å·¥å…·</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/simulation.html&from=/embedded_dev/tools/simulation.html"><span class="label">ä»¿çœŸå¹³å°</span><span class=""></span></a></li>
</ul>
</li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>ç”µæºç®¡ç†æ¨¡å—è¯¦ç»†åˆ†æ</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="æœ€åä¿®æ”¹æ—¥æœŸï¼š 2025-07-07">
                                    2025-07-07
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <h2 id="%E6%A8%A1%E5%9D%97%E6%A6%82%E8%BF%B0">æ¨¡å—æ¦‚è¿°</h2>
<p>ç”µæºç®¡ç†æ¨¡å—æ˜¯OpenEarable 2.0çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„ç”µæºçŠ¶æ€ç®¡ç†ã€ç”µæ± ç›‘æ§ã€å……ç”µæ§åˆ¶ç­‰åŠŸèƒ½ã€‚è¯¥æ¨¡å—é‡‡ç”¨äº†åŒèŠ¯ç‰‡æ¶æ„ï¼Œé€šè¿‡BQ27220ç‡ƒæ–™è®¡é‡èŠ¯ç‰‡å’ŒBQ25120aå……ç”µç®¡ç†èŠ¯ç‰‡å®ç°å®Œæ•´çš„ç”µæºè§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84">æ–‡ä»¶ç»“æ„</h2>

<pre class="language-none"><code class="language-none">src/Battery/
â”œâ”€â”€ PowerManager.h/.cpp    # ç”µæºç®¡ç†å™¨ä¸»ç±»
â”œâ”€â”€ BQ27220.h/.cpp        # ç‡ƒæ–™è®¡é‡èŠ¯ç‰‡é©±åŠ¨
â”œâ”€â”€ BQ25120a.h/.cpp       # å……ç”µç®¡ç†èŠ¯ç‰‡é©±åŠ¨
â”œâ”€â”€ BootState.h/.c        # å¯åŠ¨çŠ¶æ€ç®¡ç†
â”œâ”€â”€ CMakeLists.txt        # æ„å»ºé…ç½®
â””â”€â”€ Kconfig              # é…ç½®é€‰é¡¹
</code></pre>
<h2 id="%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%88%86%E6%9E%90">æ ¸å¿ƒç±»åˆ†æ</h2>
<h3 id="1.-PowerManager-%E7%B1%BB">1. PowerManager ç±»</h3>
<p>PowerManageræ˜¯ç”µæºç®¡ç†çš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£åè°ƒå„ä¸ªç”µæºç»„ä»¶çš„å·¥ä½œã€‚</p>
<h4 id="%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">ä¸»è¦åŠŸèƒ½</h4>
<ul>
<li><strong>ç³»ç»Ÿç”µæºæ§åˆ¶</strong>: å¼€å…³æœºã€é‡å¯ç­‰</li>
<li><strong>å……ç”µçŠ¶æ€ç›‘æ§</strong>: å®æ—¶ç›‘æ§å……ç”µçŠ¶æ€å˜åŒ–</li>
<li><strong>ç”µæ± çŠ¶æ€ç®¡ç†</strong>: ç”µé‡ã€å¥åº·çŠ¶æ€ã€æ¸©åº¦ç­‰</li>
<li><strong>ç”µæºå¼‚å¸¸å¤„ç†</strong>: ä½ç”µé‡ä¿æŠ¤ã€å……ç”µæ•…éšœå¤„ç†</li>
<li><strong>LEDçŠ¶æ€æŒ‡ç¤º</strong>: é€šè¿‡LEDæ˜¾ç¤ºç”µæºçŠ¶æ€</li>
</ul>
<h4 id="%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95">å…³é”®æ–¹æ³•</h4>

<pre class="language-cpp"><code class="language-cpp">class PowerManager {
public:
    int begin();                    // åˆå§‹åŒ–ç”µæºç®¡ç†å™¨
    int power_down(bool fault);     // ç³»ç»Ÿå…³æœº
    void reboot();                  // ç³»ç»Ÿé‡å¯

    // çŠ¶æ€æŸ¥è¯¢æ¥å£
    void get_battery_status(battery_level_status &amp;status);
    void get_energy_status(battery_energy_status &amp;status);
    void get_health_status(battery_health_status &amp;status);

    void set_error_led(int val);    // é”™è¯¯LEDæ§åˆ¶
};
</code></pre>
<h4 id="%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%9E%B6%E6%9E%84">å·¥ä½œé˜Ÿåˆ—æ¶æ„</h4>
<p>PowerManagerä½¿ç”¨Zephyrçš„å·¥ä½œé˜Ÿåˆ—ç³»ç»Ÿå®ç°å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼š</p>

<pre class="language-cpp"><code class="language-cpp">// å»¶è¿Ÿå·¥ä½œé˜Ÿåˆ—å®šä¹‰
K_WORK_DELAYABLE_DEFINE(PowerManager::charge_ctrl_delayable, charge_ctrl_work_handler);
K_WORK_DELAYABLE_DEFINE(PowerManager::power_down_work, power_down_work_handler);

// å³æ—¶å·¥ä½œé˜Ÿåˆ—å®šä¹‰
K_WORK_DEFINE(PowerManager::fuel_gauge_work, fuel_gauge_work_handler);
K_WORK_DEFINE(PowerManager::battery_controller_work, battery_controller_work_handler);
</code></pre>
<h4 id="%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6">ä¸­æ–­å¤„ç†æœºåˆ¶</h4>

<pre class="language-cpp"><code class="language-cpp">// ç‡ƒæ–™è®¡é‡èŠ¯ç‰‡ä¸­æ–­å¤„ç†
void fuel_gauge_callback(const struct device *dev, struct gpio_callback *cb, uint32_t pins);

// å……ç”µæ§åˆ¶èŠ¯ç‰‡ä¸­æ–­å¤„ç†
void battery_controller_callback(const struct device *dev, struct gpio_callback *cb, uint32_t pins);

// ç”µæºè¿æ¥çŠ¶æ€ä¸­æ–­å¤„ç†
void power_good_callback(const struct device *dev, struct gpio_callback *cb, uint32_t pins);
</code></pre>
<h3 id="2.-BQ27220-%E7%87%83%E6%96%99%E8%AE%A1%E9%87%8F%E8%8A%AF%E7%89%87%E9%A9%B1%E5%8A%A8">2. BQ27220 ç‡ƒæ–™è®¡é‡èŠ¯ç‰‡é©±åŠ¨</h3>
<p>BQ27220æ˜¯å¾·å·ä»ªå™¨(TI)çš„å•èŠ‚é”‚ç¦»å­ç”µæ± ç‡ƒæ–™è®¡é‡èŠ¯ç‰‡ï¼Œæä¾›ç²¾ç¡®çš„ç”µæ± çŠ¶æ€ä¿¡æ¯ã€‚</p>
<h4 id="%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">ä¸»è¦åŠŸèƒ½</h4>
<ul>
<li><strong>ç”µæ± çŠ¶æ€ç›‘æ§</strong>: ç”µå‹ã€ç”µæµã€æ¸©åº¦ã€ç”µé‡ç™¾åˆ†æ¯”</li>
<li><strong>ç”µæ± å¥åº·è¯„ä¼°</strong>: å¾ªç¯æ¬¡æ•°ã€å¥åº·çŠ¶æ€ã€å‰©ä½™å®¹é‡</li>
<li><strong>å®‰å…¨ä¿æŠ¤</strong>: è¿‡å‹ã€æ¬ å‹ã€è¿‡æ¸©ä¿æŠ¤</li>
<li><strong>æ ¡å‡†åŠŸèƒ½</strong>: æ”¯æŒç”µæ± å®¹é‡æ ¡å‡†</li>
</ul>
<h4 id="%E5%AF%84%E5%AD%98%E5%99%A8%E5%AE%9A%E4%B9%89">å¯„å­˜å™¨å®šä¹‰</h4>

<pre class="language-cpp"><code class="language-cpp">enum registers : uint8_t {
    CTRL = 0x00,        // æ§åˆ¶å¯„å­˜å™¨
    TEMP = 0x06,        // æ¸©åº¦å¯„å­˜å™¨
    VOLT = 0x08,        // ç”µå‹å¯„å­˜å™¨
    AI = 0x14,          // å¹³å‡ç”µæµå¯„å­˜å™¨
    FLAGS = 0x0A,       // çŠ¶æ€æ ‡å¿—å¯„å­˜å™¨
    NAC = 0x0C,         // æ ‡ç§°å¯ç”¨å®¹é‡
    FCC = 0x12,         // æ»¡å……å®¹é‡
    SOC = 0x2C,         // ç”µé‡ç™¾åˆ†æ¯”
    SOH = 0x2E,         // å¥åº·çŠ¶æ€
};
</code></pre>
<h4 id="%E7%94%B5%E6%B1%A0%E7%8A%B6%E6%80%81%E7%BB%93%E6%9E%84">ç”µæ± çŠ¶æ€ç»“æ„</h4>

<pre class="language-cpp"><code class="language-cpp">struct bat_status {
    bool DSG;           // æ”¾ç”µçŠ¶æ€
    bool SYSDWN;        // ç³»ç»Ÿå…³æœºç”µå‹
    bool TDA;           // æ¸©åº¦æ•°æ®å¯ç”¨
    bool BATTPRES;      // ç”µæ± å­˜åœ¨
    bool AUTH_GD;       // è®¤è¯è‰¯å¥½
    bool OCVGD;         // å¼€è·¯ç”µå‹è‰¯å¥½
    bool TCA;           // æ¸©åº¦è¡¥å¿å¯ç”¨
    bool CHGINH;        // å……ç”µç¦æ­¢
    bool FC;            // å……ç”µå®Œæˆ
    bool OTD;           // æ”¾ç”µè¿‡æ¸©
    bool OTC;           // å……ç”µè¿‡æ¸©
    bool SLEEP;         // ç¡çœ æ¨¡å¼
    bool OCVFAIL;       // å¼€è·¯ç”µå‹å¤±è´¥
    bool OCVCOMP;       // å¼€è·¯ç”µå‹è¡¥å¿
    bool FD;            // å®Œå…¨æ”¾ç”µ
};
</code></pre>
<h4 id="%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95">å…³é”®æ–¹æ³•</h4>

<pre class="language-cpp"><code class="language-cpp">class BQ27220 {
public:
    int begin();                          // åˆå§‹åŒ–èŠ¯ç‰‡
    float voltage();                      // è¯»å–ç”µå‹
    float current();                      // è¯»å–ç”µæµ
    float temperature();                  // è¯»å–æ¸©åº¦
    float state_of_charge();              // è¯»å–ç”µé‡ç™¾åˆ†æ¯”
    float state_of_health();              // è¯»å–å¥åº·çŠ¶æ€

    bat_status battery_status();          // è¯»å–ç”µæ± çŠ¶æ€
    gauge_status gauging_state();         // è¯»å–è®¡é‡çŠ¶æ€

    int calibration_enter();              // è¿›å…¥æ ¡å‡†æ¨¡å¼
    int calibration_exit();               // é€€å‡ºæ ¡å‡†æ¨¡å¼
    int config_update_enter();            // è¿›å…¥é…ç½®æ›´æ–°æ¨¡å¼
    int config_update_exit();             // é€€å‡ºé…ç½®æ›´æ–°æ¨¡å¼
};
</code></pre>
<h3 id="3.-BQ25120a-%E5%85%85%E7%94%B5%E7%AE%A1%E7%90%86%E8%8A%AF%E7%89%87%E9%A9%B1%E5%8A%A8">3. BQ25120a å……ç”µç®¡ç†èŠ¯ç‰‡é©±åŠ¨</h3>
<p>BQ25120aæ˜¯TIçš„ä½åŠŸè€—çº¿æ€§å……ç”µç®¡ç†èŠ¯ç‰‡ï¼Œä¸“ä¸ºä¾¿æºå¼è®¾å¤‡è®¾è®¡ã€‚</p>
<h4 id="%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">ä¸»è¦åŠŸèƒ½</h4>
<ul>
<li><strong>å……ç”µæ§åˆ¶</strong>: æ’æµ/æ’å‹å……ç”µï¼Œå……ç”µç”µæµå¯è°ƒ</li>
<li><strong>ç”µæºè·¯å¾„ç®¡ç†</strong>: æ”¯æŒè¾¹å……è¾¹ç”¨</li>
<li><strong>æŒ‰é”®æ£€æµ‹</strong>: é›†æˆæŒ‰é”®æ£€æµ‹åŠŸèƒ½</li>
<li><strong>è´Ÿè½½å¼€å…³</strong>: é›†æˆLDOå’Œè´Ÿè½½å¼€å…³</li>
<li><strong>å®‰å…¨ä¿æŠ¤</strong>: è¿‡å‹ã€è¿‡æµã€è¿‡æ¸©ä¿æŠ¤</li>
</ul>
<h4 id="%E5%AF%84%E5%AD%98%E5%99%A8%E5%AE%9A%E4%B9%89">å¯„å­˜å™¨å®šä¹‰</h4>

<pre class="language-cpp"><code class="language-cpp">enum registers : uint8_t {
    CTRL = 0x00,            // æ§åˆ¶å¯„å­˜å™¨
    FAULT = 0x01,           // æ•…éšœçŠ¶æ€å¯„å­˜å™¨
    TS_FAULT = 0x02,        // æ¸©åº¦ä¼ æ„Ÿå™¨æ•…éšœå¯„å­˜å™¨
    CHARGE_CTRL = 0x03,     // å……ç”µæ§åˆ¶å¯„å­˜å™¨
    TERM_CTRL = 0x04,       // ç»ˆæ­¢æ§åˆ¶å¯„å­˜å™¨
    BAT_VOL_CTRL = 0x05,    // ç”µæ± ç”µå‹æ§åˆ¶å¯„å­˜å™¨
    LS_LDO_CTRL = 0x07,     // è´Ÿè½½å¼€å…³/LDOæ§åˆ¶å¯„å­˜å™¨
    BTN_CTRL = 0x08,        // æŒ‰é”®æ§åˆ¶å¯„å­˜å™¨
    ILIM_UVLO = 0x09        // è¾“å…¥é™æµ/æ¬ å‹é”å®šå¯„å­˜å™¨
};
</code></pre>
<h4 id="%E5%85%85%E7%94%B5%E7%8A%B6%E6%80%81%E7%BB%93%E6%9E%84">å……ç”µçŠ¶æ€ç»“æ„</h4>

<pre class="language-cpp"><code class="language-cpp">struct chrg_state {
    float mAh;              // å……ç”µç”µæµ(mA)
    bool enabled;           // å……ç”µä½¿èƒ½
    bool high_impedance;    // é«˜é˜»æŠ—æ¨¡å¼
};

struct button_state {
    bool wake_1;            // å”¤é†’æŒ‰é”®1çŠ¶æ€
    bool wake_2;            // å”¤é†’æŒ‰é”®2çŠ¶æ€
};
</code></pre>
<h4 id="%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95">å…³é”®æ–¹æ³•</h4>

<pre class="language-cpp"><code class="language-cpp">class BQ25120a {
public:
    int begin();                              // åˆå§‹åŒ–èŠ¯ç‰‡

    // ç”µæºæ§åˆ¶
    bool power_connected();                   // æ£€æµ‹ç”µæºè¿æ¥
    void enter_high_impedance();             // è¿›å…¥é«˜é˜»æŠ—æ¨¡å¼
    void exit_high_impedance();              // é€€å‡ºé«˜é˜»æŠ—æ¨¡å¼

    // å……ç”µæ§åˆ¶
    void disable_charge();                    // ç¦ç”¨å……ç”µ
    void enable_charge();                     // ä½¿èƒ½å……ç”µ
    uint8_t read_charging_state();            // è¯»å–å……ç”µçŠ¶æ€

    // æ•…éšœæ£€æµ‹
    uint8_t read_fault();                     // è¯»å–æ•…éšœçŠ¶æ€
    uint8_t read_ts_fault();                  // è¯»å–æ¸©åº¦ä¼ æ„Ÿå™¨æ•…éšœ

    // æŒ‰é”®æ£€æµ‹
    button_state read_button_state();         // è¯»å–æŒ‰é”®çŠ¶æ€

    // å›è°ƒè®¾ç½®
    int set_power_connect_callback(gpio_callback_handler_t handler);
    int set_int_callback(gpio_callback_handler_t handler);
};
</code></pre>
<h2 id="%E7%94%B5%E6%BA%90%E7%AE%A1%E7%90%86%E7%8A%B6%E6%80%81%E6%9C%BA">ç”µæºç®¡ç†çŠ¶æ€æœº</h2>
<h3 id="%E5%85%85%E7%94%B5%E7%8A%B6%E6%80%81%E5%AE%9A%E4%B9%89">å……ç”µçŠ¶æ€å®šä¹‰</h3>

<pre class="language-cpp"><code class="language-cpp">enum charging_state {
    DISCHARGING,        // æ”¾ç”µçŠ¶æ€
    POWER_CONNECTED,    // ç”µæºå·²è¿æ¥
    PRECHARGING,        // é¢„å……ç”µçŠ¶æ€
    CHARGING,           // æ­£åœ¨å……ç”µ
    TRICKLE_CHARGING,   // æ¶“æµå……ç”µ
    FULLY_CHARGED,      // å……ç”µå®Œæˆ
    BATTERY_LOW,        // ç”µæ± ä½ç”µé‡
    BATTERY_CRITICAL,   // ç”µæ± ä¸¥é‡ä½ç”µé‡
    FAULT               // æ•…éšœçŠ¶æ€
};
</code></pre>
<h3 id="%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E9%80%BB%E8%BE%91">çŠ¶æ€è½¬æ¢é€»è¾‘</h3>

<pre class="language-cpp"><code class="language-cpp">void PowerManager::charge_task() {
    // è¯»å–å……ç”µçŠ¶æ€
    uint16_t charging_state = battery_controller.read_charging_state() &gt;&gt; 6;

    switch (charging_state) {
        case 0: // æ”¾ç”µçŠ¶æ€
            msg.charging_state = DISCHARGING;

            // æ£€æŸ¥ä½ç”µé‡çŠ¶æ€
            gauge_status gs = fuel_gauge.gauging_state();
            if (gs.edv2) msg.charging_state = BATTERY_LOW;
            if (gs.edv1) msg.charging_state = BATTERY_CRITICAL;
            break;

        case 1: // å……ç”µçŠ¶æ€
            // æ£€æŸ¥ç³»ç»Ÿå…³æœºç”µå‹
            if (bat.SYSDWN) {
                msg.charging_state = PRECHARGING;
                break;
            }

            // åˆ†æå……ç”µå‚æ•°
            float current = fuel_gauge.current();
            float target_current = fuel_gauge.charge_current();
            float voltage = fuel_gauge.voltage();

            // åˆ¤æ–­å…·ä½“å……ç”µé˜¶æ®µ
            if (current &gt; 0.8 * target_current - 2 * i_term) {
                msg.charging_state = CHARGING;
            } else if (voltage &gt; u_term - 0.02) {
                msg.charging_state = TRICKLE_CHARGING;
            }
            break;

        case 2: // å……ç”µå®Œæˆ
            msg.charging_state = FULLY_CHARGED;
            break;

        case 3: // æ•…éšœçŠ¶æ€
            msg.charging_state = FAULT;
            break;
    }
}
</code></pre>
<h2 id="LED%E7%8A%B6%E6%80%81%E6%8C%87%E7%A4%BA">LEDçŠ¶æ€æŒ‡ç¤º</h2>
<h3 id="%E5%85%85%E7%94%B5%E7%8A%B6%E6%80%81LED">å……ç”µçŠ¶æ€LED</h3>
<table>
<thead>
<tr>
  <th>LEDçŠ¶æ€</th>
  <th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
  <td>ğŸŸ¥ çº¢è‰²å¸¸äº®</td>
  <td>ç”µæ± æ•…éšœæˆ–æ·±åº¦æ”¾ç”µ</td>
</tr>
<tr>
  <td>ğŸ”´ çº¢è‰²è„‰å†²</td>
  <td>é¢„å……ç”µé˜¶æ®µ</td>
</tr>
<tr>
  <td>ğŸŸ§ æ©™è‰²å¸¸äº®</td>
  <td>ç”µæºè¿æ¥ï¼Œå……ç”µç”µæµæœªè¾¾åˆ°ç›®æ ‡</td>
</tr>
<tr>
  <td>ğŸŸ  æ©™è‰²è„‰å†²</td>
  <td>å……ç”µç”µæµè¾¾åˆ°ç›®æ ‡çš„80%</td>
</tr>
<tr>
  <td>ğŸŸ¢ ç»¿è‰²è„‰å†²</td>
  <td>æ¶“æµå……ç”µ</td>
</tr>
<tr>
  <td>ğŸŸ© ç»¿è‰²å¸¸äº®</td>
  <td>å……ç”µå®Œæˆ</td>
</tr>
</tbody>
</table>
<h3 id="%E6%94%BE%E7%94%B5%E7%8A%B6%E6%80%81LED">æ”¾ç”µçŠ¶æ€LED</h3>
<table>
<thead>
<tr>
  <th>LEDçŠ¶æ€</th>
  <th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
  <td>ğŸŸ  æ©™è‰²é—ªçƒ</td>
  <td>ç”µæ± ä½ç”µé‡(7%å‰©ä½™)</td>
</tr>
<tr>
  <td>ğŸ”´ çº¢è‰²é—ªçƒ</td>
  <td>ç”µæ± ä¸¥é‡ä½ç”µé‡(3%å‰©ä½™)</td>
</tr>
</tbody>
</table>
<h2 id="%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0">é…ç½®å‚æ•°</h2>
<h3 id="%E7%94%B5%E6%B1%A0%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE">ç”µæ± å‚æ•°é…ç½®</h3>

<pre class="language-cpp"><code class="language-cpp">struct battery_settings {
    uint16_t capacity_mAh;      // ç”µæ± å®¹é‡(mAh)
    uint16_t nominal_voltage_mV; // æ ‡ç§°ç”µå‹(mV)
    uint16_t max_voltage_mV;    // æœ€å¤§ç”µå‹(mV)
    uint16_t charge_current_mA; // å……ç”µç”µæµ(mA)
    uint16_t taper_current_mA;  // æ¶“æµå……ç”µç”µæµ(mA)
    float u_term;               // ç»ˆæ­¢ç”µå‹(V)
    float i_term;               // ç»ˆæ­¢ç”µæµ(mA)
};
</code></pre>
<h3 id="Kconfig%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9">Kconfigé…ç½®é€‰é¡¹</h3>

<pre class="language-kconfig"><code class="language-kconfig">CONFIG_BATTERY_CHARGE_CONTROLLER_NORMAL_INTERVAL_SECONDS=5
CONFIG_BATTERY_ENABLE_LOW_STATE=y
CONFIG_BATTERY_ENABLE_TRICKLE_CHARGE=y
</code></pre>
<h2 id="%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E9%9B%86%E6%88%90">æ¶ˆæ¯æ€»çº¿é›†æˆ</h2>
<p>ç”µæºç®¡ç†æ¨¡å—ä½¿ç”¨Zephyrçš„ZBusæ¶ˆæ¯æ€»çº¿ä¸å…¶ä»–æ¨¡å—é€šä¿¡ï¼š</p>

<pre class="language-cpp"><code class="language-cpp">// å®šä¹‰ç”µæ± æ•°æ®é€šé“
ZBUS_CHAN_DEFINE(battery_chan, struct battery_data, NULL, NULL, 
                 ZBUS_OBSERVERS_EMPTY, ZBUS_MSG_INIT(0));

// ç”µæ± æ•°æ®ç»“æ„
struct battery_data {
    float battery_level;        // ç”µé‡ç™¾åˆ†æ¯”
    enum charging_state charging_state; // å……ç”µçŠ¶æ€
};
</code></pre>
<h2 id="%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6">é”™è¯¯å¤„ç†æœºåˆ¶</h2>
<h3 id="%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B">æ•…éšœæ£€æµ‹</h3>

<pre class="language-cpp"><code class="language-cpp">void PowerManager::handle_fault(uint8_t fault_code) {
    // è®¾ç½®é”™è¯¯LED
    set_error_led(1);

    // è®°å½•æ•…éšœä¿¡æ¯
    LOG_ERR(&quot;Battery fault detected: 0x%02X&quot;, fault_code);

    // æ ¹æ®æ•…éšœç±»å‹é‡‡å–æªæ–½
    switch (fault_code) {
        case OVER_TEMP_FAULT:
            disable_charging();
            break;
        case OVER_VOLTAGE_FAULT:
            emergency_shutdown();
            break;
        // ... å…¶ä»–æ•…éšœå¤„ç†
    }
}
</code></pre>
<h3 id="%E4%BD%8E%E7%94%B5%E9%87%8F%E4%BF%9D%E6%8A%A4">ä½ç”µé‡ä¿æŠ¤</h3>

<pre class="language-cpp"><code class="language-cpp">void PowerManager::check_low_battery() {
    if (power_on &amp;&amp; battery_status.SYSDWN) {
        LOG_WRN(&quot;Battery reached system down voltage.&quot;);
        k_work_reschedule(&amp;power_down_work, K_NO_WAIT);
    }
}
</code></pre>
<h2 id="%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">æ€§èƒ½ä¼˜åŒ–</h2>
<h3 id="%E5%8A%9F%E8%80%97%E4%BC%98%E5%8C%96">åŠŸè€—ä¼˜åŒ–</h3>
<ul>
<li>ä½¿ç”¨é«˜é˜»æŠ—æ¨¡å¼å‡å°‘å¾…æœºåŠŸè€—</li>
<li>åŠ¨æ€è°ƒæ•´ç›‘æ§é—´éš”</li>
<li>æ™ºèƒ½ç”µæºè·¯å¾„ç®¡ç†</li>
</ul>
<h3 id="%E7%B2%BE%E5%BA%A6%E4%BC%98%E5%8C%96">ç²¾åº¦ä¼˜åŒ–</h3>
<ul>
<li>ç”µæ± å‚æ•°æ ¡å‡†</li>
<li>æ¸©åº¦è¡¥å¿</li>
<li>è€åŒ–è¡¥å¿ç®—æ³•</li>
</ul>
<h2 id="%E6%80%BB%E7%BB%93">æ€»ç»“</h2>
<p>ç”µæºç®¡ç†æ¨¡å—é€šè¿‡åŒèŠ¯ç‰‡æ¶æ„å®ç°äº†å®Œæ•´çš„ç”µæºè§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li><strong>å®Œæ•´çš„ç”µæºçŠ¶æ€ç›‘æ§</strong>: ç”µé‡ã€ç”µå‹ã€ç”µæµã€æ¸©åº¦ç­‰å‚æ•°å®æ—¶ç›‘æ§</li>
<li><strong>æ™ºèƒ½å……ç”µç®¡ç†</strong>: æ”¯æŒå¤šé˜¶æ®µå……ç”µå’Œå„ç§ä¿æŠ¤åŠŸèƒ½</li>
<li><strong>ç”¨æˆ·å‹å¥½çš„çŠ¶æ€æŒ‡ç¤º</strong>: é€šè¿‡LEDç›´è§‚æ˜¾ç¤ºç”µæºçŠ¶æ€</li>
<li><strong>ç³»ç»Ÿé›†æˆå‹å¥½</strong>: é€šè¿‡æ¶ˆæ¯æ€»çº¿ä¸å…¶ä»–æ¨¡å—é€šä¿¡</li>
<li><strong>å®‰å…¨å¯é </strong>: å¤šé‡ä¿æŠ¤æœºåˆ¶ç¡®ä¿ç³»ç»Ÿå®‰å…¨</li>
</ol>
<p>è¯¥æ¨¡å—ä¸ºOpenEarable 2.0æä¾›äº†ç¨³å®šå¯é çš„ç”µæºåŸºç¡€ï¼Œæ”¯æŒé•¿æ—¶é—´è¿è¡Œå’Œå®‰å…¨çš„å……ç”µä½“éªŒã€‚</p>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/lhfdoc.github.io/embedded_dev/openearable/teedoc-guide.html">
                            <span class="icon"></span>
                            <span class="label">ğŸ“– teedocä½¿ç”¨æŒ‡å—</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/lhfdoc.github.io/embedded_dev/openearable/audio-module.html">
                            <span class="label">ğŸµ éŸ³é¢‘å¤„ç†æ¨¡å—</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>ç›¸å…³èµ„æº</a><ul><li><a target="_blank" href="https://www.nordicsemi.com/">Nordicå®˜ç½‘</a></li>
<li><a target="_blank" href="https://zephyrproject.org/">Zephyré¡¹ç›®</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/lhfdoc.github.io/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/main.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/css/theme_default/prism.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/search/search_main.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/custom.js"></script>
    
</body>

</html>