<!DOCTYPE html>

<html lang="zh-CN"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/lhfdoc.github.io/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/search/style.css" type="text/css"/>
        
        <link rel="stylesheet" href="/lhfdoc.github.io/static/css/custom.css" type="text/css"/>
        
    
    
    <title>OpenEarable 2.0 - I2Cé€šä¿¡æ¨¡å— (Wire Module) - 7h4Worker</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": null, "update": [], "ts": 0, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/lhfdoc.github.io/">
                
                
                    <h2>åµŒå…¥å¼å¼€å‘</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
</ul>

            </div>
            <div>
                <ul id="nav_right">
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">æœç´¢</span>
                            <div id="search_hints">
                                <span id="search_input_hint">è¾“å…¥å…³é”®è¯ï¼Œå¤šå…³é”®è¯ç©ºæ ¼éš”å¼€</span>
                                <span id="search_loading_hint">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™ã€‚ã€‚ã€‚</span>
                                <span id="search_download_err_hint">ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œ</span>
                                <span id="search_other_docs_result_hint">æ¥è‡ªå…¶å®ƒæ–‡æ¡£çš„ç»“æœ</span>
                                <span id="search_curr_doc_result_hint">å½“å‰æ–‡æ¡£æœç´¢ç»“æœ</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/index.html"><span class="label">åµŒå…¥å¼å¼€å‘</span><span class=""></span></a></li>
<li class="active_parent no_link"><a><span class="label">ğŸ§ OpenEarable 2.0</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/index.html"><span class="label">é¡¹ç›®å…¥é—¨</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/project-overview.html"><span class="label">ğŸ“‹ é¡¹ç›®æ¦‚è¿°</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/architecture.html"><span class="label">ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/deployment.html"><span class="label">ğŸš€ éƒ¨ç½²æŒ‡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/teedoc-guide.html"><span class="label">ğŸ“– teedocä½¿ç”¨æŒ‡å—</span><span class=""></span></a></li>
<li class="not_active no_link"><a><span class="label">æ ¸å¿ƒåŠŸèƒ½æ¨¡å—</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/battery-module.html"><span class="label">ğŸ”‹ ç”µæºç®¡ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/audio-module.html"><span class="label">ğŸµ éŸ³é¢‘å¤„ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/sensor-module.html"><span class="label">ğŸ“¡ ä¼ æ„Ÿå™¨ç®¡ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/bluetooth-module.html"><span class="label">ğŸ“¶ è“ç‰™é€šä¿¡æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/storage-module.html"><span class="label">ğŸ’¾ æ•°æ®å­˜å‚¨æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/drivers-module.html"><span class="label">ğŸ”§ ç¡¬ä»¶é©±åŠ¨æ¨¡å—</span><span class=""></span></a></li>
</ul>
</li>
<li class="active_parent no_link"><a><span class="label">è¾…åŠ©åŠŸèƒ½æ¨¡å—</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/buttons-module.html"><span class="label">ğŸ® æŒ‰é”®å¤„ç†æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/parseinfo-module.html"><span class="label">ğŸ“Š æ•°æ®è§£ææ¨¡å—</span><span class=""></span></a></li>
<li class="active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/wire-module.html"><span class="label">ğŸ”Œ I2Cé€šä¿¡æ¨¡å—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/openearable/utils-module.html"><span class="label">ğŸ› ï¸ ç³»ç»Ÿå·¥å…·æ¨¡å—</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ğŸ’» ç¡¬ä»¶å¹³å°</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/nordic.html&from=/embedded_dev/hardware_platforms/nordic.html"><span class="label">Nordic nRFç³»åˆ—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/esp32.html&from=/embedded_dev/hardware_platforms/esp32.html"><span class="label">ESP32ç³»åˆ—</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=hardware_platforms/stm32.html&from=/embedded_dev/hardware_platforms/stm32.html"><span class="label">STM32ç³»åˆ—</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">âš™ï¸ å®æ—¶æ“ä½œç³»ç»Ÿ</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/zephyr.html&from=/embedded_dev/rtos/zephyr.html"><span class="label">Zephyr RTOS</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/freertos.html&from=/embedded_dev/rtos/freertos.html"><span class="label">FreeRTOS</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=rtos/rtthread.html&from=/embedded_dev/rtos/rtthread.html"><span class="label">RT-Thread</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ğŸ”— é€šä¿¡åè®®</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/bluetooth.html&from=/embedded_dev/protocols/bluetooth.html"><span class="label">è“ç‰™åè®®</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/wifi.html&from=/embedded_dev/protocols/wifi.html"><span class="label">WiFiåè®®</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=protocols/lora.html&from=/embedded_dev/protocols/lora.html"><span class="label">LoRa/LoRaWAN</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">ğŸ› ï¸ å¼€å‘å·¥å…·</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/ide.html&from=/embedded_dev/tools/ide.html"><span class="label">IDEç¯å¢ƒ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/debug.html&from=/embedded_dev/tools/debug.html"><span class="label">è°ƒè¯•å·¥å…·</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/lhfdoc.github.io/embedded_dev/no_translate.html?ref=tools/simulation.html&from=/embedded_dev/tools/simulation.html"><span class="label">ä»¿çœŸå¹³å°</span><span class=""></span></a></li>
</ul>
</li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>OpenEarable 2.0 - I2Cé€šä¿¡æ¨¡å— (Wire Module)</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="æœ€åä¿®æ”¹æ—¥æœŸï¼š 2025-07-07">
                                    2025-07-07
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <h2 id="%E6%A6%82%E8%BF%B0">æ¦‚è¿°</h2>
<p>I2Cé€šä¿¡æ¨¡å—ä¸ºOpenEarableè®¾å¤‡æä¾›äº†Arduinoé£æ ¼çš„I2Cé€šä¿¡æ¥å£ï¼ŒåŸºäºZephyr RTOSçš„I2Cé©±åŠ¨å®ç°ã€‚è¯¥æ¨¡å—å°è£…äº†åº•å±‚çš„I2Cç¡¬ä»¶æ“ä½œï¼Œä¸ºä¸Šå±‚é©±åŠ¨å’Œåº”ç”¨æä¾›äº†ç®€æ´æ˜“ç”¨çš„é€šä¿¡æ¥å£ã€‚</p>
<h2 id="%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6">æ ¸å¿ƒç»„ä»¶</h2>
<h3 id="1.-Arduino%E9%A3%8E%E6%A0%BCI2C%E6%8E%A5%E5%8F%A3-%28%3Ccode%3EWire.h/cpp%3C/code%3E%29">1. Arduinoé£æ ¼I2Cæ¥å£ (<code>Wire.h/cpp</code>)</h3>
<p>æä¾›ä¸Arduino Wireåº“å…¼å®¹çš„I2Cæ¥å£ï¼š</p>
<h4 id="%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%AE%9A%E4%B9%89">æ ¸å¿ƒç±»å®šä¹‰</h4>

<pre class="language-cpp"><code class="language-cpp">class MbedI2C {
public:
    MbedI2C(const struct device * master);

    // åŸºæœ¬æ“ä½œ
    virtual void begin(uint32_t speed = I2C_SPEED_FAST);
    virtual void end();
    virtual void setClock(uint32_t freq);

    // ä¼ è¾“æ“ä½œ
    virtual void beginTransmission(uint8_t address);
    virtual uint8_t endTransmission(bool stopBit = true);
    virtual size_t requestFrom(uint8_t address, size_t len, bool stopBit = true);

    // æ•°æ®æ“ä½œ
    virtual size_t write(uint8_t data);
    virtual size_t write(const uint8_t* data, int len);
    virtual int read();
    virtual int peek();
    virtual void flush();
    virtual int available();

    // å›è°ƒè®¾ç½®
    virtual void onReceive(void(*)(int));
    virtual void onRequest(void(*)(void));

    // èµ„æºç®¡ç†
    void aquire();
    void release();

private:
    const struct device * master;
    struct k_mutex mutex;

    // ç¼“å†²åŒº
    char buf[BUFFER_RX_SIZE];
    RingBufferN&lt;BUFFER_RX_SIZE&gt; rxBuffer;
    uint8_t txBuffer[BUFFER_TX_SIZE];
    uint32_t usedTxBuffer;

    // åº•å±‚æ“ä½œ
    int master_read(int address, const char * buf, const uint32_t len, bool no_stop);
    int master_write(int address, const char * buf, const uint32_t len, bool no_stop);
    int i2c_message(uint8_t read_write, int address, const char * buf, 
                   const uint32_t len, bool no_stop);
};
</code></pre>
<h4 id="%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0">é…ç½®å‚æ•°</h4>

<pre class="language-cpp"><code class="language-cpp">#define BUFFER_TX_SIZE 256    // å‘é€ç¼“å†²åŒºå¤§å°
#define BUFFER_RX_SIZE 512    // æ¥æ”¶ç¼“å†²åŒºå¤§å°
</code></pre>
<h3 id="2.-%E5%9F%BA%E7%A1%80I2C%E7%AE%A1%E7%90%86-%28%3Ccode%3ETWIM.h/cpp%3C/code%3E%29">2. åŸºç¡€I2Cç®¡ç† (<code>TWIM.h/cpp</code>)</h3>
<p>æä¾›æ›´åº•å±‚çš„I2Cç®¡ç†æ¥å£ï¼š</p>

<pre class="language-cpp"><code class="language-cpp">class TWIM {
public:
    TWIM(const struct device * master);
    virtual void begin();
    virtual void end();
    virtual void setClock(uint32_t speed = I2C_SPEED_FAST);

    void aquire();
    void release();

    const struct device * master;

private:
    struct k_mutex mutex;
};
</code></pre>
<h3 id="3.-%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2%E5%8C%BA-%28%3Ccode%3ERingBuffer.h%3C/code%3E%29">3. ç¯å½¢ç¼“å†²åŒº (<code>RingBuffer.h</code>)</h3>
<p>ç”¨äºI2Cæ•°æ®ç¼“å†²çš„ç¯å½¢ç¼“å†²åŒºå®ç°ï¼š</p>

<pre class="language-cpp"><code class="language-cpp">template&lt;int N&gt;
class RingBufferN {
private:
    uint8_t _buffer[N];
    volatile int _head;
    volatile int _tail;

public:
    void store_char(uint8_t c);
    int read_char();
    int available();
    int peek();
    void clear();
    bool isFull();
};
</code></pre>
<h2 id="%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">å·¥ä½œæœºåˆ¶</h2>
<h3 id="1.-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">1. åˆå§‹åŒ–æµç¨‹</h3>

<pre class="language-cpp"><code class="language-cpp">void MbedI2C::begin(uint32_t speed) {
    // 1. æ£€æŸ¥è®¾å¤‡å°±ç»ªçŠ¶æ€
    if (!device_is_ready(master)) {
        LOG_ERR(&quot;I2C device not ready&quot;);
        return;
    }

    // 2. é…ç½®I2Cæ—¶é’Ÿé€Ÿåº¦
    setClock(speed);

    // 3. åˆå§‹åŒ–ç¼“å†²åŒº
    rxBuffer.clear();
    usedTxBuffer = 0;

    // 4. åˆå§‹åŒ–äº’æ–¥é”
    k_mutex_init(&amp;mutex);
}
</code></pre>
<h3 id="2.-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E6%B5%81%E7%A8%8B">2. æ•°æ®ä¼ è¾“æµç¨‹</h3>
<h4 id="%E4%B8%BB%E6%9C%BA%E5%86%99%E6%93%8D%E4%BD%9C">ä¸»æœºå†™æ“ä½œ</h4>

<pre class="language-cpp"><code class="language-cpp">void beginTransmission(uint8_t address) {
    _address = address;
    usedTxBuffer = 0;  // æ¸…ç©ºå‘é€ç¼“å†²åŒº
}

size_t write(uint8_t data) {
    if (usedTxBuffer &lt; BUFFER_TX_SIZE) {
        txBuffer[usedTxBuffer++] = data;
        return 1;
    }
    return 0;
}

uint8_t endTransmission(bool stopBit) {
    int ret = master_write(_address, (const char*)txBuffer, usedTxBuffer, !stopBit);
    usedTxBuffer = 0;
    return (ret == 0) ? 0 : 4;  // 0=æˆåŠŸ, 4=å…¶ä»–é”™è¯¯
}
</code></pre>
<h4 id="%E4%B8%BB%E6%9C%BA%E8%AF%BB%E6%93%8D%E4%BD%9C">ä¸»æœºè¯»æ“ä½œ</h4>

<pre class="language-cpp"><code class="language-cpp">size_t requestFrom(uint8_t address, size_t len, bool stopBit) {
    char buffer[len];
    int ret = master_read(address, buffer, len, !stopBit);

    if (ret == 0) {
        // å°†æ•°æ®å­˜å…¥ç¯å½¢ç¼“å†²åŒº
        for (size_t i = 0; i &lt; len; i++) {
            rxBuffer.store_char(buffer[i]);
        }
        return len;
    }
    return 0;
}

int read() {
    return rxBuffer.read_char();
}
</code></pre>
<h3 id="3.-%E5%BA%95%E5%B1%82I2C%E6%93%8D%E4%BD%9C">3. åº•å±‚I2Cæ“ä½œ</h3>

<pre class="language-cpp"><code class="language-cpp">int i2c_message(uint8_t read_write, int address, const char * buf, 
               const uint32_t len, bool no_stop) {
    struct i2c_msg msg;

    msg.buf = (uint8_t*)buf;
    msg.len = len;
    msg.flags = read_write;
    if (no_stop) {
        msg.flags |= I2C_MSG_STOP;
    }

    return i2c_transfer(master, &amp;msg, 1, address);
}
</code></pre>
<h2 id="%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8">çº¿ç¨‹å®‰å…¨</h2>
<h3 id="%E4%BA%92%E6%96%A5%E9%94%81%E4%BF%9D%E6%8A%A4">äº’æ–¥é”ä¿æŠ¤</h3>

<pre class="language-cpp"><code class="language-cpp">void aquire() {
    k_mutex_lock(&amp;mutex, K_FOREVER);
}

void release() {
    k_mutex_unlock(&amp;mutex);
}
</code></pre>
<h3 id="%E5%85%B8%E5%9E%8B%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F">å…¸å‹ä½¿ç”¨æ¨¡å¼</h3>

<pre class="language-cpp"><code class="language-cpp">wire.aquire();
wire.beginTransmission(device_address);
wire.write(register_address);
wire.write(data);
wire.endTransmission();
wire.release();
</code></pre>
<h2 id="%E7%BC%93%E5%86%B2%E5%8C%BA%E7%AE%A1%E7%90%86">ç¼“å†²åŒºç®¡ç†</h2>
<h3 id="%E5%8F%91%E9%80%81%E7%BC%93%E5%86%B2%E5%8C%BA">å‘é€ç¼“å†²åŒº</h3>
<ul>
<li>å›ºå®šå¤§å°256å­—èŠ‚</li>
<li>åœ¨ <code>beginTransmission</code> æ—¶æ¸…ç©º</li>
<li>åœ¨ <code>endTransmission</code> æ—¶å‘é€</li>
</ul>
<h3 id="%E6%8E%A5%E6%94%B6%E7%BC%93%E5%86%B2%E5%8C%BA">æ¥æ”¶ç¼“å†²åŒº</h3>
<ul>
<li>ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºï¼Œå¤§å°512å­—èŠ‚</li>
<li>æ”¯æŒæµå¼æ•°æ®æ¥æ”¶</li>
<li>æä¾› <code>available()</code> æŸ¥è¯¢å¯è¯»æ•°æ®é‡</li>
</ul>
<h3 id="%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2%E5%8C%BA%E6%93%8D%E4%BD%9C">ç¯å½¢ç¼“å†²åŒºæ“ä½œ</h3>

<pre class="language-cpp"><code class="language-cpp">template&lt;int N&gt;
void RingBufferN&lt;N&gt;::store_char(uint8_t c) {
    int next_head = (_head + 1) % N;
    if (next_head != _tail) {
        _buffer[_head] = c;
        _head = next_head;
    }
}

template&lt;int N&gt;
int RingBufferN&lt;N&gt;::read_char() {
    if (_head == _tail) {
        return -1;  // ç¼“å†²åŒºç©º
    }

    uint8_t c = _buffer[_tail];
    _tail = (_tail + 1) % N;
    return c;
}
</code></pre>
<h2 id="%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">é”™è¯¯å¤„ç†</h2>
<h3 id="%E8%AE%BE%E5%A4%87%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5">è®¾å¤‡çŠ¶æ€æ£€æŸ¥</h3>

<pre class="language-cpp"><code class="language-cpp">if (!device_is_ready(master)) {
    LOG_ERR(&quot;I2C master device %s not ready&quot;, master-&gt;name);
    return -ENODEV;
}
</code></pre>
<h3 id="%E4%BC%A0%E8%BE%93%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">ä¼ è¾“é”™è¯¯å¤„ç†</h3>

<pre class="language-cpp"><code class="language-cpp">int ret = i2c_transfer(master, msgs, num_msgs, addr);
if (ret != 0) {
    LOG_ERR(&quot;I2C transfer failed: %d&quot;, ret);
    return ret;
}
</code></pre>
<h3 id="%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E4%BF%9D%E6%8A%A4">ç¼“å†²åŒºæº¢å‡ºä¿æŠ¤</h3>

<pre class="language-cpp"><code class="language-cpp">size_t write(const uint8_t* data, int len) {
    size_t written = 0;
    for (int i = 0; i &lt; len &amp;&amp; usedTxBuffer &lt; BUFFER_TX_SIZE; i++) {
        txBuffer[usedTxBuffer++] = data[i];
        written++;
    }
    return written;
}
</code></pre>
<h2 id="%E8%AE%BE%E5%A4%87%E9%9B%86%E6%88%90">è®¾å¤‡é›†æˆ</h2>
<h3 id="%E8%AE%BE%E5%A4%87%E6%A0%91%E9%85%8D%E7%BD%AE">è®¾å¤‡æ ‘é…ç½®</h3>

<pre class="language-dts"><code class="language-dts">&amp;i2c0 {
    status = &quot;okay&quot;;
    clock-frequency = &lt;I2C_BITRATE_FAST&gt;;

    sensor@48 {
        compatible = &quot;example,sensor&quot;;
        reg = &lt;0x48&gt;;
    };
};
</code></pre>
<h3 id="%E9%A9%B1%E5%8A%A8%E5%AE%9E%E4%BE%8B%E5%8C%96">é©±åŠ¨å®ä¾‹åŒ–</h3>

<pre class="language-cpp"><code class="language-cpp">// è·å–I2Cè®¾å¤‡
const struct device *i2c_dev = DEVICE_DT_GET(DT_NODELABEL(i2c0));

// åˆ›å»ºWireå®ä¾‹
MbedI2C wire(i2c_dev);

// åˆå§‹åŒ–
wire.begin(I2C_SPEED_FAST);
</code></pre>
<h2 id="%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">å…¸å‹åº”ç”¨åœºæ™¯</h2>
<h3 id="1.-%E4%BC%A0%E6%84%9F%E5%99%A8%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96">1. ä¼ æ„Ÿå™¨æ•°æ®è¯»å–</h3>

<pre class="language-cpp"><code class="language-cpp">// è¯»å–ä¼ æ„Ÿå™¨å¯„å­˜å™¨
uint8_t readSensorRegister(uint8_t addr, uint8_t reg) {
    wire.aquire();

    wire.beginTransmission(addr);
    wire.write(reg);
    wire.endTransmission(false);  // é‡å¤å¯åŠ¨

    wire.requestFrom(addr, 1);
    uint8_t data = wire.read();

    wire.release();
    return data;
}
</code></pre>
<h3 id="2.-%E4%BC%A0%E6%84%9F%E5%99%A8%E9%85%8D%E7%BD%AE%E5%86%99%E5%85%A5">2. ä¼ æ„Ÿå™¨é…ç½®å†™å…¥</h3>

<pre class="language-cpp"><code class="language-cpp">// å†™å…¥ä¼ æ„Ÿå™¨å¯„å­˜å™¨
void writeSensorRegister(uint8_t addr, uint8_t reg, uint8_t value) {
    wire.aquire();

    wire.beginTransmission(addr);
    wire.write(reg);
    wire.write(value);
    wire.endTransmission();

    wire.release();
}
</code></pre>
<h3 id="3.-%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93">3. æ‰¹é‡æ•°æ®ä¼ è¾“</h3>

<pre class="language-cpp"><code class="language-cpp">// è¯»å–å¤šä¸ªè¿ç»­å¯„å­˜å™¨
void readMultipleRegisters(uint8_t addr, uint8_t startReg, 
                          uint8_t* buffer, size_t len) {
    wire.aquire();

    wire.beginTransmission(addr);
    wire.write(startReg);
    wire.endTransmission(false);

    wire.requestFrom(addr, len);
    for (size_t i = 0; i &lt; len; i++) {
        buffer[i] = wire.read();
    }

    wire.release();
}
</code></pre>
<h2 id="%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">æ€§èƒ½ä¼˜åŒ–</h2>
<h3 id="%E6%97%B6%E9%92%9F%E9%85%8D%E7%BD%AE">æ—¶é’Ÿé…ç½®</h3>

<pre class="language-cpp"><code class="language-cpp">void setClock(uint32_t freq) {
    struct i2c_config config;
    config.frequency = freq;
    config.flags = I2C_MODE_MASTER;

    i2c_configure(master, &amp;config);
}
</code></pre>
<h3 id="%E6%94%AF%E6%8C%81%E7%9A%84%E6%97%B6%E9%92%9F%E9%80%9F%E5%BA%A6">æ”¯æŒçš„æ—¶é’Ÿé€Ÿåº¦</h3>
<ul>
<li><strong>I2C_SPEED_STANDARD</strong>: 100 kHz</li>
<li><strong>I2C_SPEED_FAST</strong>: 400 kHz</li>
<li><strong>I2C_SPEED_FAST_PLUS</strong>: 1 MHz</li>
</ul>
<h3 id="%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BC%98%E5%8C%96">ç¼“å†²åŒºä¼˜åŒ–</h3>
<ul>
<li>åˆç†çš„ç¼“å†²åŒºå¤§å°é…ç½®</li>
<li>é¿å…é¢‘ç¹çš„å°æ•°æ®ä¼ è¾“</li>
<li>æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡</li>
</ul>
<h2 id="%E8%B0%83%E8%AF%95%E6%94%AF%E6%8C%81">è°ƒè¯•æ”¯æŒ</h2>
<h3 id="%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95">æ—¥å¿—è®°å½•</h3>

<pre class="language-cpp"><code class="language-cpp">#include &lt;zephyr/logging/log.h&gt;
LOG_MODULE_REGISTER(wire, CONFIG_WIRE_LOG_LEVEL);

LOG_DBG(&quot;I2C write to 0x%02x: %d bytes&quot;, address, len);
LOG_ERR(&quot;I2C transfer failed: %d&quot;, ret);
</code></pre>
<h3 id="%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7">çŠ¶æ€ç›‘æ§</h3>
<ul>
<li>ä¼ è¾“æˆåŠŸ/å¤±è´¥ç»Ÿè®¡</li>
<li>ç¼“å†²åŒºä½¿ç”¨æƒ…å†µç›‘æ§</li>
<li>è®¾å¤‡å“åº”æ—¶é—´æµ‹é‡</li>
</ul>
<h2 id="%E6%80%BB%E7%BB%93">æ€»ç»“</h2>
<p>I2Cé€šä¿¡æ¨¡å—æä¾›äº†å®Œæ•´çš„I2Cé€šä¿¡æ”¯æŒï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li><strong>å…¼å®¹æ€§</strong>: Arduino Wireåº“å…¼å®¹æ¥å£</li>
<li><strong>å¯é æ€§</strong>: å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥</li>
<li><strong>é«˜æ•ˆæ€§</strong>: ä¼˜åŒ–çš„ç¼“å†²åŒºç®¡ç†å’Œæ‰¹é‡ä¼ è¾“</li>
<li><strong>çº¿ç¨‹å®‰å…¨</strong>: äº’æ–¥é”ä¿æŠ¤çš„å¹¶å‘è®¿é—®</li>
<li><strong>çµæ´»æ€§</strong>: æ”¯æŒå¤šç§æ—¶é’Ÿé€Ÿåº¦å’Œä¼ è¾“æ¨¡å¼</li>
</ol>
<p>è¯¥æ¨¡å—ä¸ºOpenEarableè®¾å¤‡çš„ä¼ æ„Ÿå™¨å’Œå¤–è®¾é€šä¿¡æä¾›äº†ç¨³å®šå¯é çš„I2Cé€šä¿¡åŸºç¡€è®¾æ–½ã€‚</p>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/lhfdoc.github.io/embedded_dev/openearable/parseinfo-module.html">
                            <span class="icon"></span>
                            <span class="label">ğŸ“Š æ•°æ®è§£ææ¨¡å—</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/lhfdoc.github.io/embedded_dev/openearable/utils-module.html">
                            <span class="label">ğŸ› ï¸ ç³»ç»Ÿå·¥å…·æ¨¡å—</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>ç›¸å…³èµ„æº</a><ul><li><a target="_blank" href="https://www.nordicsemi.com/">Nordicå®˜ç½‘</a></li>
<li><a target="_blank" href="https://zephyrproject.org/">Zephyré¡¹ç›®</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/lhfdoc.github.io/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/main.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/css/theme_default/prism.min.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/search/search_main.js"></script>
    
        <script src="/lhfdoc.github.io/static/js/custom.js"></script>
    
</body>

</html>